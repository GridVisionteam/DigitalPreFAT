<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="style.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate PDF Report</title>
    <!-- Use CDN with local fallback -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/downloadjs@1.4.7"></script>
    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // Fallback for PDF-Lib if CDN fails
        if (typeof PDFLib === 'undefined') {
            document.write('<script src="pdf-lib.min.js"><\/script>');
        }
        // Fallback for downloadjs if CDN fails
        if (typeof download === 'undefined') {
            document.write('<script src="download.js"><\/script>');
        }
    </script>
</head>
<body>
    <img src="Icon/GV.png" alt="Logo" class="logo" id="logo" title="Go to Login Page">
    
    <div class="pdf-generation-container">
        <h1>PDF Generation</h1>
        <div class="status-box">
            <p id="generationStatus">Ready to generate PDF report...</p>
            <div class="progress-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>
        </div>
        
        <!-- Drive Upload Status -->
        <div id="driveStatusContainer" style="margin-top: 20px; display: none;">
            <div class="drive-status-header" style="font-weight: bold; margin-bottom: 5px;">Google Drive Status:</div>
            <div id="driveStatus" class="drive-status" style="padding: 15px; border-radius: 4px; min-height: 60px; display: flex; align-items: center;">
                <!-- Status will be shown here -->
            </div>
            <div id="driveLink" style="margin-top: 10px; display: none;">
                <a id="driveLinkAnchor" target="_blank" style="color: #2196F3; text-decoration: none;">Open in Google Drive</a>
            </div>
        </div>
        
        <div class="button-container">
            <button id="backBtn" onclick="window.location.href='signature.html'">Back (A)</button>
            <button id="StartNewSession" onclick="startNewSession()">Start New Session</button>
            <button id="generatePdfBtn" onclick="generateFinalPdf()">Generate PDF Report</button>
            <button id="generateAndUploadBtn" onclick="generateAndUploadToDrive()" style="background-color: #2196F3;">Generate & Upload to Drive</button>
        </div>
    </div>

    <script src="commonFunctions.js"></script>
    <script src="generateJSON.js"></script>
    <script src="googleDrive.js"></script> <!-- Added this line -->
    <script src="generatePDF.js"></script>
    <script>
        // Function to handle back navigation
        function goToBack() {
            const backBtn = document.getElementById('backBtn');
            if (backBtn) {
                backBtn.click();
            }
        }

        document.addEventListener('keydown', function(event) {
            // Check if we're in an input field
            const isInputField = event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA';
            
            // Only trigger shortcuts if not typing in an input field
            if (!isInputField) {
                if (event.key === 'a' || event.key === 'A' || event.keyCode === 65 || event.keyCode === 97) {
                    event.preventDefault();
                    goToBack();
                }
            }
        });
    </script>
    <script>
        // Expose the function to the global scope
        window.startNewSession = startNewSession;
        
        // Function to update drive status
        window.updateDriveStatus = function(message, isError = false, isSuccess = false, link = null) {
            const driveStatusContainer = document.getElementById('driveStatusContainer');
            const driveStatusElement = document.getElementById('driveStatus');
            const driveLink = document.getElementById('driveLink');
            const driveLinkAnchor = document.getElementById('driveLinkAnchor');
            
            if (!driveStatusElement) return;
            
            // Show container
            driveStatusContainer.style.display = 'block';
            
            // Set message
            driveStatusElement.textContent = message;
            driveStatusElement.className = 'drive-status';
            
            if (isError) {
                driveStatusElement.style.backgroundColor = '#f8d7da';
                driveStatusElement.style.color = '#721c24';
                driveStatusElement.style.border = '1px solid #f5c6cb';
                driveLink.style.display = 'none';
            } else if (isSuccess) {
                driveStatusElement.style.backgroundColor = '#d4edda';
                driveStatusElement.style.color = '#155724';
                driveStatusElement.style.border = '1px solid #c3e6cb';
            } else {
                driveStatusElement.style.backgroundColor = '#d1ecf1';
                driveStatusElement.style.color = '#0c5460';
                driveStatusElement.style.border = '1px solid #bee5eb';
            }
            
            // Handle link
            if (link) {
                driveLink.style.display = 'block';
                driveLinkAnchor.href = link;
                driveLinkAnchor.textContent = 'üìé ' + link;
                
                // Also log to console for debugging
                console.log('Google Drive Link:', link);
            } else {
                driveLink.style.display = 'none';
            }
        };
        
        // Modified to use the external JSON generation functions
        async function generateFinalPdf() {
            const statusElement = document.getElementById('generationStatus');
            const progressBar = document.getElementById('progressBar');
            
            try {
                statusElement.textContent = "Loading user data...";
                progressBar.style.width = '10%';
                
                // Load user data
                const userData = loadUserData();
                
                statusElement.textContent = "Generating PDF and JSON...";
                progressBar.style.width = '30%';
                
                // Generate the PDF
                await generateFinalPDF(userData);
                
                // Also generate JSON backup using the external function
                generateJsonFile();
                
                statusElement.textContent = "PDF and JSON generated successfully!";
                progressBar.style.width = '100%';
                progressBar.style.backgroundColor = '#4CAF50';
                
            } catch (error) {
                statusElement.textContent = "Generation failed: " + error.message;
                progressBar.style.width = '100%';
                progressBar.style.backgroundColor = '#f44336';
                console.error("Generation failed:", error);
            }
        }
        
        // New function to generate and upload to Google Drive
        // In generatePDF.html - modify the generateAndUploadToDrive function
        async function generateAndUploadToDrive() {
            const statusElement = document.getElementById('generationStatus');
            const progressBar = document.getElementById('progressBar');
            const uploadBtn = document.getElementById('generateAndUploadBtn');
            
            // Disable button during process
            if (uploadBtn) {
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Processing...';
            }
            
            try {
                // Step 1: Generate PDF and JSON first
                statusElement.textContent = "Loading user data...";
                progressBar.style.width = '10%';
                updateDriveStatus("Starting PDF generation...", false, false);
                
                // Load user data
                const userData = loadUserData();
                
                statusElement.textContent = "Generating PDF...";
                progressBar.style.width = '20%';
                updateDriveStatus("Generating PDF document...", false, false);
                
                // Generate the PDF bytes
                if (typeof window.generateFinalPDFBytes !== 'function') {
                    throw new Error("PDF generation function not available");
                }
                const pdfBytes = await window.generateFinalPDFBytes(userData);
                
                // Step 2: Generate JSON backup
                progressBar.style.width = '30%';
                updateDriveStatus("Generating JSON backup...", false, false);
                
                // Get JSON content
                const jsonContent = generateJsonFromLocalStorage();
                const jsonBlob = new Blob([jsonContent], { type: 'application/json' });
                const jsonBytes = await new Uint8Array(await new Response(jsonBlob).arrayBuffer());
                
                // Create filenames
                const now = new Date();
                const dateformat = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
                const pdfFileName = `${dateformat}_RTU_Report_${localStorage.getItem('session_contractNo') || 'ContractNo'}_${localStorage.getItem('session_rtuSerial') || 'SerialNo'}.pdf`;
                const jsonFileName = `${dateformat}_RTU_Backup_${localStorage.getItem('session_contractNo') || 'ContractNo'}_${localStorage.getItem('session_rtuSerial') || 'SerialNo'}.json`;
                
                // Step 3: Prepare files for batch upload
                progressBar.style.width = '40%';
                updateDriveStatus("Preparing files for Google Drive...", false, false);
                
                const filesToUpload = [
                    {
                        data: pdfBytes,
                        name: pdfFileName,
                        mimeType: 'application/pdf'
                    },
                    {
                        data: jsonBytes,
                        name: jsonFileName,
                        mimeType: 'application/json'
                    }
                ];
                
                // Step 4: Upload both files with SINGLE authentication
                progressBar.style.width = '50%';
                updateDriveStatus("Authenticating with Google Drive...", false, false);
                
                if (typeof window.batchUploadToDrive === 'function') {
                    // Use batch upload for better performance
                    const uploadResults = await window.batchUploadToDrive(filesToUpload);
                    
                    // Get the PDF upload result for creating shareable link
                    const pdfUploadResult = uploadResults[0];
                    
                    progressBar.style.width = '70%';
                    updateDriveStatus("Creating shareable link...", false, false);
                    
                    // Create shareable link for the PDF
                    let shareableLink = null;
                    if (pdfUploadResult && pdfUploadResult.id && typeof window.createShareableLink === 'function') {
                        shareableLink = await window.createShareableLink(pdfUploadResult.id);
                    }
                    
                    // Complete
                    statusElement.textContent = "Files uploaded to Google Drive!";
                    progressBar.style.width = '100%';
                    progressBar.style.backgroundColor = '#4CAF50';
                    
                    if (shareableLink) {
                        updateDriveStatus('‚úÖ Both files uploaded to Google Drive!', false, true, shareableLink);
                        
                        // Auto-open in new tab after 2 seconds
                        setTimeout(() => {
                            if (confirm('Files uploaded to Google Drive!\n\nClick OK to open PDF in new tab, or Cancel to stay here.')) {
                                window.open(shareableLink, '_blank');
                            }
                        }, 2000);
                    } else if (pdfUploadResult && pdfUploadResult.id) {
                        const driveLink = `https://drive.google.com/file/d/${pdfUploadResult.id}/view`;
                        updateDriveStatus('‚úÖ Both files uploaded to Google Drive!', false, true, driveLink);
                    } else {
                        updateDriveStatus('‚úÖ Both files uploaded to Google Drive!', false, true);
                    }
                } else {
                    // Fallback to individual uploads (will still use cached token)
                    progressBar.style.width = '60%';
                    updateDriveStatus("Uploading PDF to Google Drive...", false, false);
                    
                    const uploadResult = await window.uploadToDrive(pdfBytes, pdfFileName, 'application/pdf');
                    
                    progressBar.style.width = '80%';
                    updateDriveStatus("Uploading JSON to Google Drive...", false, false);
                    
                    await window.uploadToDrive(jsonBytes, jsonFileName, 'application/json');
                    
                    progressBar.style.width = '90%';
                    updateDriveStatus("Creating shareable link...", false, false);
                    
                    let shareableLink = null;
                    if (typeof window.createShareableLink === 'function') {
                        shareableLink = await window.createShareableLink(uploadResult.id);
                    }
                    
                    // Complete (same as above)
                    statusElement.textContent = "Files uploaded to Google Drive!";
                    progressBar.style.width = '100%';
                    progressBar.style.backgroundColor = '#4CAF50';
                    
                    if (shareableLink) {
                        updateDriveStatus('‚úÖ Both files uploaded to Google Drive!', false, true, shareableLink);
                        
                        setTimeout(() => {
                            if (confirm('Files uploaded to Google Drive!\n\nClick OK to open PDF in new tab, or Cancel to stay here.')) {
                                window.open(shareableLink, '_blank');
                            }
                        }, 2000);
                    } else if (uploadResult && uploadResult.id) {
                        const driveLink = `https://drive.google.com/file/d/${uploadResult.id}/view`;
                        updateDriveStatus('‚úÖ Both files uploaded to Google Drive!', false, true, driveLink);
                    } else {
                        updateDriveStatus('‚úÖ Both files uploaded to Google Drive!', false, true);
                    }
                }
                
                // Also offer local downloads
                // ... (keep your existing download code)
                
            } catch (error) {
                console.error("Generation/upload failed:", error);
                statusElement.textContent = "Process failed: " + error.message;
                progressBar.style.width = '100%';
                progressBar.style.backgroundColor = '#f44336';
                
                updateDriveStatus(`‚ùå Upload failed: ${error.message}`, true, false);
                
                // If upload fails, still try to generate local files
                try {
                    const userData = loadUserData();
                    await generateFinalPDF(userData);
                    generateJsonFile();
                    updateDriveStatus("‚ùå Upload failed, but local files were generated.", true, false);
                } catch (localError) {
                    console.error("Local generation also failed:", localError);
                }
            } finally {
                // Re-enable button
                if (uploadBtn) {
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'Generate & Upload to Drive';
                }
            }
        }
    </script>
    
    <style>
        .pdf-generation-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        
        .status-box {
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .progress-container {
            width: 100%;
            background-color: #ddd;
            border-radius: 4px;
            margin-top: 15px;
        }
        
        .progress-bar {
            height: 20px;
            width: 0;
            background-color: #2196F3;
            border-radius: 4px;
            transition: width 0.3s, background-color 0.3s;
        }
        
        .button-container {
            margin-top: 20px;
        }
        
        button {
            padding: 10px 20px;
            margin: 0 10px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        #generateAndUploadBtn:hover {
            background-color: #0b7dda;
        }
        
        .drive-status {
            padding: 10px 15px;
            border-radius: 4px;
            margin-top: 15px;
            font-weight: bold;
            text-align: left;
            word-break: break-word;
        }
        
        .drive-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .drive-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .drive-status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .drive-config-info {
            margin-top: 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            font-size: 14px;
            text-align: left;
        }
        
        .drive-config-info h3 {
            margin-top: 0;
            color: #666;
        }
        
        .drive-config-info a {
            color: #2196F3;
            text-decoration: none;
        }
        
        .drive-config-info a:hover {
            text-decoration: underline;
        }
    </style>
</body>

</html>


